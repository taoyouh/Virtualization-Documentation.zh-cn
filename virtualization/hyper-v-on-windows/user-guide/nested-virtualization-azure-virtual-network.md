---
title: 配置嵌套虚拟机直接与 Azure 虚拟网络中的资源进行通信
description: 嵌套虚拟化
keywords: windows 10 的 hyper-v Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 18ab4d1d87c22f70fe09aae5222a7d125ac9c974
ms.sourcegitcommit: 914e0dd1168daf1d2b0f22bd011035016cc08baf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/23/2019
ms.locfileid: "9099385"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>配置嵌套虚拟机与 Azure 虚拟网络中的资源进行通信

部署和配置 Azure 内的嵌套的虚拟机上的原始指南，必须通过 NAT 交换机访问这些虚拟机。 这样便提供了几个限制：

1. 嵌套的虚拟机无法访问本地资源的或在 Azure 虚拟网络内。
2. 在本地资源或在 Azure 中的资源只能访问嵌套的虚拟机通过一个 NAT，这意味着多个来宾不能共享同一个端口。

本文档将指导完成对方我们充分利用 RRAS，用户定义的路由，专用于以允许来宾 internet 访问和"浮动"的地址空间的出站 NAT 子网，以允许嵌套的虚拟机的行为，并像任何其他虚拟机进行通信的部署部署直接向内 Azure VNet。

在开始本指南中，请： 之前

1. 读取[指南提供了](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization)嵌套虚拟化。
2. 阅读本文整个之前实现。

## <a name="high-level-overview-of-what-were-doing-and-why"></a>我们将执行的操作的高级别概述和原因
* 我们将创建具有两个 Nic 的嵌套能够 VM。 
* 一个 NIC 将用于提供 NAT 和其他 NIC 通过 internet 访问权限，我们嵌套的虚拟机将用于将从我们内部交换机外部的资源的通信路由到虚拟机监控程序。 每个 NIC 将需要在不同的路由域中，这意味着不同的子网。
* 这意味着，我们需要使用在最小的三个子网的虚拟网络。 一个 NAT，一个用于 LAN 路由，，一个未使用，但我们嵌套的虚拟机的"保留"。 我们使用此文档中的子网的名称是，"NAT"，"超-V 的 LAN"和"Ghosted"。
* 这些子网的大小由你决定，但有一些注意事项。 "Ghosted"子网的大小确定多少 Ip 你有嵌套虚拟机。 此外，"NAT"和"超-V 的 LAN"子网的大小确定多少 Ip 必须为虚拟机监控程序。 因此如果你仅计划上有一个或两个虚拟机监控程序是从技术上讲可以使此处非常小的子网。
* 背景： 嵌套的虚拟机不会从其主机连接到，即使你配置的内部或外部交换机 VNet 接收 DHCP。 
  * 这意味着在 HYPER-V 主机必须提供 DHCP。
* 在 HYPER-V 主机不知道 VNet 上的当前已分配租约，因此为了避免在其中宿主已分配 IP 存在的情况下我们必须为 HYPER-V 主机只需使用分配的 Ip 的块。 这将允许我们可以避免重复的 IP 方案。
  * 我们选择的 Ip 的块将对应于你 HYPER-V 位于同一个 VNet 内的子网。
  * 我们希望它对应于现有的子网的原因是返回到 ExpressRoute 处理 BGP 广告。 如果我们只需组成要使用的 HYPER-V 主机的 IP 范围，则我们将需要创建一系列静态路由以使客户端在本地与嵌套的虚拟机进行通信。 这意味着，这不是硬性要求为你无法使嵌套的虚拟机的 IP 范围，然后创建指引客户端与该范围的 HYPER-V 主机所需的所有路由。
* 我们将创建内部交换机内 HYPER-V，然后我们会将新创建的接口我们留出的 DHCP 范围内的 IP 地址。 此 IP 地址将成为默认网关我们嵌套的虚拟机的且在用于内部交换机和的主机的连接到我们 VNet NIC 之间的路线。
* 我们将在会变为路由器我们主机的主机上安装的路由和远程访问的角色。  这是需要允许对主机外部的资源和我们嵌套的虚拟机之间的通信。
* 我们将告诉其他资源如何访问这些嵌套的虚拟机。 这需要我们创建一个用户定义的路由表包含针对嵌套的虚拟机驻留在 IP 范围的静态路由。 该静态路由将指向 HYPER-V 的 IP 地址。
* 然后会将此 UDR 放置在网关子网，以便客户端来自本地知道如何到达我们嵌套的虚拟机。
* 你还将此 UDR 放在需要连接到嵌套的虚拟机的 Azure 中的任何其他子网。
* 为多个 HYPER-V 主机您可以创建其他"浮动"子网，并向 UDR 添加额外的静态路由。
* 解除授权 HYPER-V 主机时你将删除/重新调整其用途我们"浮动"的子网和删除该静态路由从我们 UDR，或如果这是最后一个 HYPER-V 主机，完全删除 UDR。

## <a name="creating-the-host"></a>创建主机

我将不再讲述配置的值最多个人首选项，例如虚拟机名称，资源组等...

1. 导航到 portal.azure.com
2. 在左上角单击"创建资源"
3. 从热门列中选择"窗口 Server 2016 虚拟机"
4. 在"基本"选项卡上确保选择能够嵌套虚拟化的虚拟机大小
5. 移至"网络"选项卡
6. 通过以下配置创建新的虚拟网络
    * VNet 地址空间： 10.0.0.0/22
    * 子网 1
        * 名称： NAT
        * 地址空间： 10.0.0.0/24
    * 子网 2
        * 名称： 超-V 的 LAN
        * 地址空间： 10.0.1.0/24
    * 子网 3
        * 名称： 做幻像。
        * 地址空间： 10.0.2.0/24
    * 子网 4
        * 名称： Azure 虚拟机
        * 地址空间： 10.0.3.0/24
7. 确保你已选择 NAT 子网的虚拟机
8. 转到"查看 + 创建"，然后选择"创建"

## <a name="create-the-second-network-interface"></a>创建第二个网络接口
1. 在虚拟机后已完成预配浏览到它在 Azure 门户
2. 停止虚拟机
3. 一次停止的转到"网络"下设置
4. "连接网络接口"
5. "创建网络接口"
6. 为它提供一个名称 （不重要你命名它，但请务必记住它）
7. 子网选择"超-V 的 LAN"
8. 确保你选择你的主机位于同一资源组
9. "创建"
10. 这将重新转到上一个屏幕，请务必选择新创建的网络接口，然后选择"确定"
11. 返回到"概述"窗格和上一个操作完成后重新启动虚拟机
12. 导航到刚创建的第二个 NIC，你可以找到它之前所选的资源组中
13. 转到"IP 配置"和"IP 转发"切换到"已启用"，然后保存更改

## <a name="setting-up-hyper-v"></a>设置 HYPER-V
1. 远程到你的主机
2. 打开一个提升的 PowerShell 提示符
3. 运行以下命令 `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 这将重启主机
5. 重新连接到主机继续设置的其余部分

## <a name="creating-our-virtual-switch"></a>创建我们虚拟交换机

1. 在管理模式下打开 PowerShell。
2. 创建内部交换机： `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 将新创建的接口分配 IP: `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>安装和配置 DHCP

*当他们首次尝试获取嵌套虚拟化工作时，许多用户忽略此组件。 与不同本地其中你来宾虚拟机将从你的主机所在，网络接收 DHCP 在 Azure 中的嵌套虚拟机必须提供 DHCP 通过主机运行。 这也需要静态分配 IP 地址为每个嵌套的虚拟机，这种方法不可扩展。*

1. 安装 DHCP 角色： `Install-WindowsFeature DHCP -IncludeManagementTools`
2. 创建 DHCP 作用域： `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 配置 DNS 和默认网关为作用域选项： `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 请务必输入有效的 DNS 服务器，如果你想要工作的名称解析。 在此情况下我使用[Azure 的递归 DNS](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)。

## <a name="installing-remote-access"></a>安装远程访问

1. 打开服务器管理器，然后选择"添加角色和功能"。
2. 选择"下一步"，直到到达"服务器角色"。
3. 检查"远程访问"并单击"下一步"，直到到达"角色服务"。
4. 检查"路由"，选择"添加功能"，然后选择"下一步"，然后再"安装"。 完成向导，并等待，以完成安装。

## <a name="configuring-remote-access"></a>配置远程访问

1. 打开服务器管理器并选择"工具"，然后选择"路由和远程访问"。
2. 在路由和远程访问管理面板的右侧你将看到与你的服务器名称在它旁边的图标，右键单击此并选择"配置并启用路由和远程访问"。
3. 在向导中，选择"下一步"、"自定义配置"，检查径向按钮，然后选择"下一步"。
4. 检查"NAT""和 LAN 路由"，然后选择"下一步"，然后"完成"。 如果它询问你是否要启动该服务，则执行此操作。
5. 现在导航到"IPv4"节点，并将其展开，以便"NAT"节点将可用。
6. 右键单击"NAT"、 选择"新接口..."然后选择"Ethernet"，这应该是你首次 NIC 的"10.0.0.4"的 IP
7. 现在我们需要创建某些静态路由以强制退出第二个 NIC 的 LAN 流量 通过转到"IPv4"下的"静态路由"节点执行此操作。
8. 一次那里我们将创建的以下路由。
    * 路由 1
        * 接口： 以太网
        * 目标： 10.0.0.0
        * 网络掩码： 255.255.255.0
        * 网关： 10.0.0.1
        * 指标： 256
        * 注意： 我们将此此处以允许主要 NIC 以响应出其自己的界面往的通信。 如果我们在此处没有以下路由将导致的 NIC 1，以转出 NIC 2。 这将创建一个非对称路线。 10.0.0.1 是 Azure 分配到 NAT 子网的 IP 地址。 Azure 将使用第一个可用 IP 范围中的默认网关。 因此，如果你要将 192.168.0.0/24 用于 NAT 子网，网关将为 192.168.0.1。 Wins，这意味着该路由将取代中路由的更具体的路由下面路线。

    * 路由 2
        * 接口： 以太网 2
        * 目标： 10.0.0.0
        * 网络掩码： 255.255.252.0
        * 网关： 10.0.1.1
        * 指标： 256
        * 注意： 这是所有想要我们 Azure VNet 流量路由 catch。 它将强制出第二个 NIC 的流量 你将需要添加所需嵌套虚拟机访问其他范围中的其他路由。 因此，如果你是在本地网络是 172.16.0.0/22，则你将需要具有其他路由将我们的虚拟机监控程序的第二个 NIC 出该流量发送。

## <a name="creating-a-route-table-within-azure"></a>创建 Azure 内的路由表

请参阅[本文](https://docs.microsoft.com/en-us/azure/virtual-network/tutorial-create-route-table-portal)有关深入阅读有关创建和管理 Azure 内的路由。

1. 导航到https://portal.azure.com。
2. 在左上角中选择"创建资源"。
3. 在搜索字段中键入"路由表"，然后点击输入。
4. 顶部的结果将是路由表，选择此项，然后依次选择"创建"
5. 命名路由表，在本例中我其名为"路由-为-嵌套的虚拟机"。
6. 请确保你选择在 HYPER-V 主机驻留在同一个订阅。
7. 创建新的资源组或选择一个现有并确保你创建路由表中的区域是在 HYPER-V 主机驻留在同一个区域。
8. 选择"创建"。

## <a name="configuring-the-route-table"></a>配置路由表

1. 导航到刚创建的路由表。 你可以通过搜索门户的顶部中心在搜索栏的路由表的名称来执行此操作。
2. 选择后路由表从转到"路线"边栏选项卡内。
3. 选择"添加"。
4. 为给定名称的路线，我与"嵌套的虚拟机"出现问题。
5. 地址前缀我们"浮动"的子网的输入的 IP 范围。 在此情况下，它将 10.0.2.0/24。
6. 对于"下一跃点类型"选择"虚拟设备"，然后输入 IP 地址 HYPER-V 托管第二个 NIC，这可能 10.0.1.4，，然后选择"确定"。
7. 现在从内边栏选项卡中选择"子网"，这将是"路线"的正下方。
8. 选择"关联"，然后选择我们"嵌套有趣"VNet，然后选择"Azure 虚拟机"子网，，然后选择"确定"。
9. 我们 HYPER-V 主机驻留在以及与需要访问嵌套的虚拟机的任何其他子网的子网中执行此相同的过程。 如果连接 

# <a name="end-state-configuration-reference"></a>结束状态配置参考
本指南中的环境具有以下配置。 本部分是需要用作引用。

1. Azure 虚拟网络的信息。
    * VNet 高级别配置。
        * 名称： 嵌套有趣
        * 地址空间： 10.0.0.0/22
        * 注意： 这将由组成的四个子网。 此外，这些范围不改变中设置。 可随意解决你的环境，但是你想。 

    * 第一个子网高级别配置。
        * 名称： NAT
        * 地址空间： 10.0.0.0/24
        * 注意： 这是我们 HYPER-V 其中托管主要 NIC 驻留。 这将用于处理嵌套的虚拟机出站 NAT。 它将为你嵌套的虚拟机的 internet 网关。

    * 第二个子网高级别配置。
        * 名称： 超-V 的 LAN
        * 地址空间： 10.0.1.0/24
        * 注意： 我们 HYPER-V 主机将拥有第二个 NIC 用于处理的路由之间的嵌套的虚拟机和 HYPER-V 主机的外部的非 internet 资源。

    * 第三个子网高级别配置。
        * 名称： 做幻像。
        * 地址空间： 10.0.2.0/24
        * 注意： 这将是"浮动"的子网。 地址空间可供应用我们嵌套的虚拟机和，用于处理返回到本地路由公布。 任何虚拟机将实际不部署到此子网中。

    * 第四个子网高级别配置。
        * 名称： Azure 虚拟机
        * 地址空间： 10.0.3.0/24
        * 注意： 包含 Azure 虚拟机的子网。

1. 我们 HYPER-V 主机具有以下 NIC 配置。
    * 主要 NIC 
        * IP 地址： 10.0.0.4
        * 子网掩码： 255.255.255.0
        * 默认网关： 10.0.0.1
        * 为 DHCP 配置 DNS:
        * 启用 IP 转发： 否

    * 辅助 NIC
        * IP 地址： 10.0.1.4
        * 子网掩码： 255.255.255.0
        * 默认网关： 空
        * 为 DHCP 配置 DNS:
        * 启用 IP 转发: 是

    * Hyper-v 为内部的虚拟交换机创建 NIC
        * IP 地址： 10.0.2.1
        * 子网掩码： 255.255.255.0
        * 默认网关： 空

3. 我们路由表将有一条规则。
    * 规则 1
        * 名称： 嵌套 Vm
        * 目标： 10.0.2.0/24
        * 下一跃点： 虚拟设备-10.0.1.4

## <a name="conclusion"></a>总结

你现在应该能够将虚拟机 (甚至是 32 位 VM ！) 部署到 HYPER-V 主机并使其可以从本地和 Azure 内访问。
