# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>保护来宾虚拟机免受 CVE-2017-5715（分支目标注入）的侵害

本页提供了有关保护 Hyper-V 主机上的来宾虚拟机免受 CVE-2017-5715（分支目标注入）的侵害的其他详细信息。  有关常规 Windows Server 指南，请参阅[本页](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)。

需要执行以下步骤来确保你的虚拟机受到保护：

1. 更新主机操作系统。
2. 确保虚拟化主机已更新为包含针对 CVE-2017-5715 的更新的固件。
3. 确保 Hyper-V 配置为向来宾虚拟机公开新处理器功能。
4. 根据需要更新来宾操作系统。 
5. 执行来宾虚拟机的冷启动。

## <a name="update-the-host-operating-system"></a>更新主机操作系统

将 Windows 操作系统更新应用于虚拟化主机。 有关如何启用此更新的详细信息，请参阅 [Microsoft 知识库文章 4072699](https://support.microsoft.com/help/4072699)。

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>确保虚拟化主机已更新为包含针对 CVE-2017-5715 的更新的固件

来自 OEM 的固件更新可能包含可用于防御 CVE-2017-5715 的新处理器功能（[IBRS、STIBP、IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)）。  在虚拟化主机的固件更新后，虚拟机监控程序可以在采取以下步骤后使这些附加功能可用于来宾虚拟机。

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>确保 Hyper-V 配置为向来宾虚拟机公开新处理器功能

确保将 Hyper-v 配置为向来宾虚拟机公开新的处理器功能。  此配置基于来宾虚拟机的 [VM 版本](https://docs.microsoft.com/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server)。 

如果主机上的所有虚拟机都为 VM 版本 8.0 或更高版本，则不需要任何配置。  这些虚拟机将在冷启动后看到新的处理器功能。

如果有任何低于 VM 版本 8.0 的虚拟机，你必须在主机操作系统上设置特定注册表值。  这会将 Hyper-V 配置为将新的处理器功能公开到 VM 版本较低的来宾虚拟机中。

该注册表值为 `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` 下的 `MinVmVersionForCpuBasedMitigations`。  该值应该以格式“Major.Minor”设置为需要访问更新的固件功能的最低 VM 版本。  要将固件公开到主机上的所有虚拟机（即版本 1.0 及更高版本），请在主机上运行以下命令： 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*注意：VM 版本 8.0 已随 Windows Server 2016 和 Windows 10 周年更新一起推出。  运行 Windows Server 2012 R2 及更低版本的主机必须设置注册表值*

*警告：具有更新固件的主机和没有更新固件的主机之间的实时迁移将会失败。  有关更多详细信息，请参阅本文档底部的常见问题。*

## <a name="optional-configure-_pre-skylake_-intel-systems-to-use-retpoline"></a>*可选*: 配置_预 Skylake_英特尔系统以使用 Retpoline

*警告: 在 Skylake 的英特尔主机上配置 Vm 将阻止实时迁移到较新的主机 (如 Skylake 和更远的主机)。*

默认情况下, 将阻止在预 Skylake 系统上运行的虚拟机使用 retpoline。  若要允许这些系统利用基于 retpoline 的缓解, `RetsPredictedFromRsbOnly`请`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`在`1`"到" 下设置。 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

若要撤消此配置 (即阻止虚拟机利用 retpoline), 请将`RetsPredictedFromRsbOnly`设置`0`为。

## <a name="update-the-guest-operating-system"></a>更新来宾操作系统

若要在这些虚拟机中完成针对 CVE-2017-5715 的保护，必须更新和配置来宾操作系统以利用这些新功能。  有关 Microsoft 操作系统，请在更新时按照[本文](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)中的指南进行操作。

*注意：在此过程中可能随时会更新来宾操作系统。  可能会在更新主机固件之前或在冷启动来宾虚拟机之后执行此更新。*

## <a name="perform-a-cold-boot-of-the-guest"></a>执行来宾的冷启动

完成前三个步骤后，虚拟机必须经过冷启动才能看到新的处理器功能。  这意味着正在运行的 VM 在重新启动之前必须完全关闭电源。  从来宾操作系统内部重启是不足够的。

## <a name="frequently-asked-questions"></a>常见问题

### <a name="how-does-this-impact-live-migration"></a>这如何影响实时迁移？

迁移到没有更新固件的 Hyper-V 主机时，具有新处理器功能的虚拟机的实时迁移将会失败。  若要实时迁移到没有更新固件的主机，请停止在该来宾虚拟机中公开更新的处理器功能。  最简单的操作方法是将 `MinVmVersionForCpuBasedMitigations` 修改为高于需要迁移的虚拟机的 VM 版本，并对该虚拟机执行冷启动。

迁移到具有更新固件的 Hyper-V 主机时，没有新处理器功能的虚拟机将会成功迁移。  但是，这些来宾需要冷启动才能查看更新的固件功能。

配置为在预 Skylake 英特尔系统上使用 Retpoline 的虚拟机将无法迁移到较新的处理器系列 (即 Skylake 和更高版本)。

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>在 Windows Server 2012 R2 和 Windows Server 2016 之间实时迁移版本 5.0 虚拟机会如何？
为确保在此情况下迁移成功，必须在 Windows Server 2012 R2 系统和 Windows Server 2016 系统上设置注册表值。  在迁移到 Windows Server 2016 上之后，VM 版本将保持 5.0，因此需要使用注册表项将新处理器功能公开到虚拟机。  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>本指南是否适用于在 VMWare 上运行的虚拟机？
否，本指南特定于在 Hyper-V 主机上运行的虚拟机。

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>本指南是否适用于 Windows 10 上的 Hyper-V？
是的，相同的步骤适用于在 Windows Server 和客户端上运行的虚拟机。

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>在执行虚拟机的冷启动之前，是否需要安装固件更新？
是，在冷启动虚拟机之前，需要更新主机操作系统和固件。

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>如果我的 OEM 尚未提供更新的固件，我该怎么做？
请查阅[适用于 Windows Server 2016 Hyper-V 主机的针对预测执行侧信道漏洞的替代保护](https://docs.microsoft.com/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>如何检查我的虚拟机的 VM 版本？
在 Hyper-V 主机上运行以下 PowerShell：
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>是否需要执行不同的操作以保护在“处理器兼容性模式”下运行的虚拟机？
否。  按照此页面上的说明进行操作后，新的处理器功能也将公开到在处理器兼容性模式下启动的虚拟机。

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>如果我的群集中只有一半机器已收到固件更新，会怎么样？
这将影响群集中的实时迁移。  具有新处理器功能的虚拟机无法在没有固件更新的情况下实时迁移到主机。  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>如何验证来宾虚拟机是否可以访问新的处理器功能？
使用“预测控制”PowerShell 模块/脚本。  请参阅[本页](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)以了解详细说明。

